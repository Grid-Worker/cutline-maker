<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>CUTLINE PRO | ë¬´ë£Œ êµ¿ì¦ˆ ì¹¼ì„ Â·ìŠ¤í‹°ì»¤ ì¬ë‹¨ì„  ìƒì„±ê¸°</title>

  <meta name="google-site-verification" content="uFwK65mQWcwjWJwzStSWQ_PqpPFA5qEup00kmWxKKAc" />
  <meta name="naver-site-verification" content="f6af1d9413497dfabd5dd844a3cb1c2c1f4d50b2" />
  <meta name="description" content="ì„¤ì¹˜ ì—†ì´ ë¸Œë¼ìš°ì €ì—ì„œ ë°”ë¡œ ìŠ¤í‹°ì»¤, ì•„í¬ë¦´ êµ¿ì¦ˆìš© ì¹¼ì„ (ì¬ë‹¨ì„ )ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”. ì´ë¯¸ì§€ ë°°ê²½ ì œê±°(ëˆ„ë¼), í™”ì´íŠ¸ ë ˆì´ì–´ ìƒì„±, ì™¸ê³½ì„  ë”°ê¸° ê¸°ëŠ¥ì„ ë¬´ë£Œë¡œ ì œê³µí•©ë‹ˆë‹¤.">
  <meta name="keywords" content="ì¹¼ì„  ë§Œë“¤ê¸°, ì¹¼ì„  ìƒì„±ê¸°, ìŠ¤í‹°ì»¤ ë„ì•ˆ, ì•„í¬ë¦´ í‚¤ë§ ì œì‘, êµ¿ì¦ˆ ì œì‘, ëˆ„ë¼ ë”°ê¸° ì‚¬ì´íŠ¸, ë°°ê²½ ì œê±°, ì˜¤í”„ì…‹, í™”ì´íŠ¸ ì¸ì‡„, ë‹¤ì´ì»·, png ë³€í™˜">
  <meta name="author" content="CUTLINE PRO">
  <meta name="robots" content="index, follow">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <meta property="og:type" content="website">
  <meta property="og:title" content="CUTLINE PRO - ì´ˆê°„í¸ êµ¿ì¦ˆ ì¹¼ì„  ìƒì„±ê¸°">
  <meta property="og:description" content="ì´ë¯¸ì§€ë§Œ ì˜¬ë¦¬ë©´ ë! ë°°ê²½ ì œê±°ë¶€í„° ì¹¼ì„  ìƒì„±ê¹Œì§€ 3ì´ˆ ì™„ì„±.">
  <meta property="og:url" content="https://Grid-Worker.github.io">

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0000000000000000" crossorigin="anonymous"></script>

  <style>
    :root {
      /* Light Theme Variables */
      --bg-app: #f3f4f6;       
      --bg-panel: #ffffff;     
      --primary: #2563eb;      
      --primary-hover: #1d4ed8;
      --accent: #ef4444;       
      --text-main: #1f2937;    
      --text-sub: #6b7280;     
      --border: #e5e7eb;       
      --radius: 12px;
      
      --header-h: 60px;
      --font-mono: "JetBrains Mono", "Consolas", monospace;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      background-color: var(--bg-app);
      color: var(--text-main);
      font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 15px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      user-select: none;
    }

    /* --- Header --- */
    header {
      height: var(--header-h);
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      z-index: 50;
      box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }
    .brand { display: flex; align-items: center; gap: 8px; font-weight: 800; font-size: 1.3rem; letter-spacing: -0.5px; color: #111; }
    .brand span { color: var(--primary); }

    /* --- Main Layout --- */
    main {
      flex: 1; 
      display: flex; 
      overflow: hidden; 
      position: relative;
      height: calc(100vh - var(--header-h));
    }

    /* --- Sidebar (Toolbar) --- */
    .toolbar {
      width: 320px;
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      padding: 20px; gap: 24px;
      flex-shrink: 0; 
      z-index: 40;
      overflow-y: auto; /* PC ìŠ¤í¬ë¡¤ */
      height: 100%;
    }
    .toolbar::-webkit-scrollbar { width: 6px; }
    .toolbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
    
    .section-title {
      font-size: 0.8rem; color: var(--text-sub); text-transform: uppercase;
      font-weight: 700; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
      letter-spacing: 0.5px;
    }

    /* Footer in Sidebar */
    .toolbar-footer {
      margin-top: auto; 
      padding-top: 20px;
      border-top: 1px dashed var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: var(--text-sub);
    }
    .toolbar-footer a { color: var(--text-sub); text-decoration: none; }

    /* --- Workspace (Center) --- */
    .workspace {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      background-color: var(--bg-app);
      position: relative;
    }

    .workspace.drag-active::after {
      content: 'ğŸ“‚ ì´ë¯¸ì§€ë¥¼ ë†“ì•„ì„œ ë¶ˆëŸ¬ì˜¤ê¸°';
      position: absolute; inset: 20px;
      border: 4px dashed var(--primary); border-radius: 20px;
      background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem; font-weight: 800; color: var(--primary);
      z-index: 100; pointer-events: none;
      box-shadow: 0 0 30px rgba(37, 99, 235, 0.2);
    }

    /* AD Banner */
    .ad-banner {
      width: 100%; height: 100px; background: #f9fafb; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center; flex-shrink: 0; z-index: 20;
    }
    .ad-placeholder {
      width: 728px; height: 90px; border: 1px dashed #d1d5db; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      color: #9ca3af; font-size: 0.85rem; background: #fff;
    }

    /* UI Components */
    button {
      background: #fff; color: var(--text-main); border: 1px solid var(--border);
      padding: 12px 0; border-radius: 8px; cursor: pointer; font-size: 0.95rem;
      display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%;
      transition: all 0.15s; font-weight: 600;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    button:hover { background: #f9fafb; border-color: #d1d5db; transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    
    button.primary {
      background: var(--primary); border-color: var(--primary); color: #fff;
      box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
    }
    button.primary:hover { background: var(--primary-hover); }
    
    button.active {
      background: #eff6ff; border-color: var(--primary); color: var(--primary);
    }
    
    button.sm { font-size: 0.85rem; padding: 10px 0; font-weight: 500; }
    .btn-row { display: flex; gap: 8px; }
    .btn-row > * { flex: 1; }
    
    input[type="range"] {
      width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px;
      -webkit-appearance: none; margin: 12px 0;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 20px; height: 20px;
      background: #fff; border: 2px solid var(--primary);
      border-radius: 50%; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .input-label { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-sub); font-weight: 500; }

    .file-drop {
      display: block; border: 2px dashed #d1d5db; border-radius: var(--radius); 
      padding: 20px; text-align: center; cursor: pointer; color: var(--text-sub); font-size: 0.9rem;
      transition: 0.2s; background: #f9fafb; user-select: none;
    }
    .file-drop:hover { border-color: var(--primary); color: var(--primary); background: #eff6ff; }

    /* --- Canvas Area --- */
    .canvas-container {
      flex: 1; position: relative;
      background-color: #ffffff;
      background-image:
        linear-gradient(45deg, #e5e7eb 25%, transparent 25%),
        linear-gradient(-45deg, #e5e7eb 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #e5e7eb 75%),
        linear-gradient(-45deg, transparent 75%, #e5e7eb 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      overflow: hidden; display: flex; align-items: center; justify-content: center;
      /* ì¤‘ìš”: ìº”ë²„ìŠ¤ë§Œ í„°ì¹˜ ì œìŠ¤ì²˜ ë§‰ê¸° (ë“œë¡œì‰/ì¤Œ ìœ„í•´) */
      touch-action: none; 
    }
    .canvas-container.erase-cursor { cursor: crosshair !important; }
    .canvas-container.point-erase-cursor { cursor: no-drop !important; }
    .canvas-container.add-point-cursor { cursor: crosshair !important; }
    .canvas-container.panning { cursor: grabbing !important; }

    .canvas-wrapper {
      position: relative; box-shadow: 0 20px 30px -5px rgba(0, 0, 0, 0.15);
      transform-origin: center center;
    }

    canvas { display: block; image-rendering: pixelated; }
    
    svg.overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      overflow: visible; pointer-events: none;
    }
    .overlay circle { 
      fill: #fff; stroke: var(--primary); stroke-width: 2px; 
      cursor: grab; transition: r 0.1s; pointer-events: auto; 
    }
    .overlay circle:hover { r: 7; fill: var(--primary); }
    .point-erase-active .overlay circle { cursor: pointer; stroke: var(--accent); }
    .point-erase-active .overlay circle:hover { fill: var(--accent); r: 8; }
    .overlay polyline { 
      fill: none; stroke: var(--primary); stroke-width: 2px; 
      stroke-linejoin: round; pointer-events: none; 
    }
    .ghost-point {
      fill: var(--accent); stroke: #fff; stroke-width: 2px;
      pointer-events: none; opacity: 0; transition: opacity 0.05s;
    }
    .ghost-point.visible { opacity: 1; r: 6; }

    /* --- Zoom Controls --- */
    .zoom-controls {
      position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px);
      padding: 8px 12px; border-radius: 99px; border: 1px solid var(--border);
      display: flex; gap: 12px; align-items: center; z-index: 20;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .zoom-btn { width: 36px; height: 36px; padding: 0; border-radius: 50%; font-size: 1.2rem; border:none; box-shadow:none; }
    .zoom-btn:hover { background: #f3f4f6; }
    .zoom-text { font-family: var(--font-mono); font-size: 0.9rem; min-width: 50px; text-align: center; color: var(--text-main); }

    /* --- Preview Panel (Desktop Only) --- */
    .preview-panel {
      width: 280px; background: var(--bg-panel); border-left: 1px solid var(--border);
      padding: 20px; display: flex; flex-direction: column; gap: 20px; flex-shrink: 0; z-index: 30;
    }
    .preview-box {
      width: 100%; aspect-ratio: 1; border-radius: var(--radius); border: 1px solid var(--border);
      background-image: linear-gradient(45deg, #e5e7eb 25%, transparent 25%), linear-gradient(-45deg, #e5e7eb 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #e5e7eb 75%), linear-gradient(-45deg, transparent 75%, #e5e7eb 75%);
      background-size: 10px 10px; background-position: 0 0, 0 5px, 5px -5px, -5px 0px;
      display: flex; align-items: center; justify-content: center; overflow: hidden;
    }
    #previewCanvas { max-width: 100%; max-height: 100%; }

    /* --- Responsive Design (Mobile Fixes) --- */
    @media (max-width: 1000px) { .preview-panel { display: none; } }
    
    @media (max-width: 768px) {
      body { 
        /* ì¤‘ìš”: ëª¨ë°”ì¼ì—ì„œ ì „ì²´ ìŠ¤í¬ë¡¤ í—ˆìš© (Toolbar ìŠ¤í¬ë¡¤ ìœ„í•´) */
        overflow: hidden; 
      }
      main { 
        flex-direction: column; 
        height: calc(100vh - var(--header-h));
      }
      
      /* Mobile Layout: Canvas Top, Toolbar Bottom */
      .workspace { 
        order: 1; 
        height: 55%; /* í™”ë©´ ìƒë‹¨ 55% í• ë‹¹ */
        flex: none; 
        border-bottom: 1px solid var(--border);
      }
      
      .toolbar { 
        order: 2; 
        width: 100%; 
        height: 45%; /* í™”ë©´ í•˜ë‹¨ 45% í• ë‹¹ */
        border-right: none; 
        overflow-y: auto !important; /* ìŠ¤í¬ë¡¤ ê°•ì œ */
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y; /* ìˆ˜ì§ ìŠ¤í¬ë¡¤ í—ˆìš© */
        padding-bottom: 40px;
      }

      .ad-banner { display: none; } /* Mobile saves space */
      
      .zoom-controls { bottom: 16px; padding: 4px 8px; }
      .zoom-btn { width: 32px; height: 32px; font-size: 1rem; }
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div style="width:24px;height:24px;background:var(--primary);border-radius:6px;"></div>
    CUTLINE<span>PRO</span>
  </div>
  <div class="status-badge" id="statusMsg"></div>
</header>

<main>
  <aside class="toolbar">
    <div>
      <label class="file-drop" id="dropZoneSidebar">
        <strong>ì´ë¯¸ì§€ ì—…ë¡œë“œ</strong><br>
        <span style="font-size:0.75rem; opacity:0.7;">(JPG, PNG, WEBP)</span>
        <input type="file" id="fileInput" accept="image/*" hidden>
      </label>
      <div class="btn-row" style="margin-top:10px;">
        <button id="undoBtn" class="sm">â†© ì‹¤í–‰ ì·¨ì†Œ</button>
        <button id="redoBtn" class="sm">â†ª ë‹¤ì‹œ ì‹¤í–‰</button>
      </div>
    </div>

    <div>
      <div class="section-title">
        ë°°ê²½ ì •ë¦¬ (ëˆ„ë¼)
        <input type="color" id="canvasBgPicker" value="#ffffff" title="ìº”ë²„ìŠ¤ ë°°ê²½ìƒ‰ ë³€ê²½" style="border:1px solid #ddd; width:20px; height:20px; padding:0; cursor:pointer; border-radius:4px;">
      </div>
      <div class="input-label"><span>í—ˆìš©ì¹˜ (Tolerance)</span> <span id="tolDisplay">30</span></div>
      <input type="range" id="toleranceInput" min="1" max="100" value="30">
      <div class="btn-row">
        <button id="removeBgBtn" class="sm">ğŸª„ ìë™ ì œê±°</button>
        <button id="erodeBtn" class="sm">âœ‚ï¸ í…Œë‘ë¦¬ ê¹ê¸°</button>
      </div>
      <button id="eraseModeBtn" class="sm" style="margin-top:8px;">ğŸ§½ ì˜ì—­ ì§€ìš°ê°œ</button>
    </div>

    <div>
      <div class="section-title">ì»·ë¼ì¸(ì¹¼ì„ ) ìƒì„±</div>
      
      <div class="input-label" style="margin-bottom:6px;">ì¶”ì²œ í”„ë¦¬ì…‹</div>
      <div class="btn-row" style="margin-bottom:12px;">
        <button class="sm" onclick="applyPreset('sticker')">ìŠ¤í‹°ì»¤</button>
        <button class="sm" onclick="applyPreset('acrylic')">ì•„í¬ë¦´</button>
        <button class="sm" onclick="applyPreset('badge')">ë°°ì§€</button>
      </div>

      <button id="autoOutlineBtn" class="primary">âš¡ ì»·ë¼ì¸ ìë™ ìƒì„±</button>
      
      <div class="input-label" style="margin-top:12px;"><span>ë‹¤ë“¬ê¸° (Smoothing)</span> <span id="smoothDisplay">0</span></div>
      <input type="range" id="smoothInput" min="0" max="10" value="0">

      <div class="btn-row" style="margin-top:8px;">
        <button id="pointEraserBtn" class="sm">âœ– ì  ì§€ìš°ê°œ</button>
        <button id="closePathBtn" class="sm">ğŸ”— ë‹«ê¸°</button>
        <button id="resetPointsBtn" class="sm">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
      </div>

      <div style="font-size:0.75rem; color:var(--text-sub); margin-top:10px; line-height:1.5;">
        * <strong style="color:var(--accent)">ë§ˆìš°ìŠ¤ ì»¤ì„œê°€ ë°”ë€” ë•Œ</strong> ì  ì¶”ê°€<br>
        * <kbd>Space</kbd> + <strong>íœ  í´ë¦­</strong>ìœ¼ë¡œ í™”ë©´ ì´ë™<br>
        * <strong>ëª¨ë°”ì¼:</strong> í•œ ì†ê°€ë½ ì´ë™, ë‘ ì†ê°€ë½ í™•ëŒ€
      </div>
    </div>

    <div>
      <div class="section-title">ìŠ¤íƒ€ì¼ ì˜µì…˜</div>
      <div class="input-label"><span>ì—¬ë°± (Margin)</span> <span id="marginDisplay">15</span>px</div>
      <input type="range" id="marginInput" min="0" max="100" value="15">
      
      <div class="input-label"><span>ë‘ê»˜ (Width)</span> <span id="widthDisplay">8</span>px</div>
      <input type="range" id="widthInput" min="0" max="40" value="8">

      <div style="display:flex; justify-content:space-between; margin-top:8px; align-items:center;">
        <span style="font-size:0.85rem; color:var(--text-sub); font-weight:500;">ë¼ì¸ ìƒ‰ìƒ</span>
        <input type="color" id="lineColorInput" value="#ef4444" style="border:1px solid #ddd; width:50px; height:24px; cursor:pointer; padding:0; border-radius:4px;">
      </div>
    </div>

    <div style="margin-top:20px;">
      <button id="downloadBtn" class="primary" style="height:50px; font-size:1rem;">
        ğŸ’¾ PNG ë‹¤ìš´ë¡œë“œ
      </button>
    </div>

    <div class="toolbar-footer">
      <div style="font-size:0.75rem; color:var(--text-sub); margin-bottom:8px;">
        ë¬¸ì˜: <a href="mailto:nosound1318@naver.com">nosound1318@naver.com</a>
      </div>

      <div style="margin-bottom:4px;">Total Visits</div>
      <a href="https://github.com/Grid-Worker/Grid-Worker.github.io" target="_blank">
        <img alt="Hits" src="https://hits.sh/Grid-Worker.github.io.svg?style=flat-square&label=Visits&color=2563eb"/>
      </a>
      <div style="font-size:0.7rem; opacity:0.5; margin-top:6px;">Â© 2025 CUTLINE PRO</div>
    </div>
  </aside>

  <div class="workspace" id="workspaceDropZone">
    <div class="ad-banner">
      <div class="ad-placeholder">Google AdSense Area (728x90)</div>
    </div>

    <section class="canvas-container" id="canvasContainer">
      <div class="canvas-wrapper" id="canvasWrapper">
        <canvas id="mainCanvas"></canvas>
        <svg id="svgOverlay" class="overlay">
          <circle id="ghostPoint" class="ghost-point" cx="0" cy="0" r="5" />
        </svg>
      </div>
      <div class="zoom-controls">
        <button class="zoom-btn" id="zoomOut">ï¼</button>
        <span class="zoom-text" id="zoomLevel">100%</span>
        <button class="zoom-btn" id="zoomIn">ï¼‹</button>
        <div style="width:1px; height:16px; background:#e5e7eb; margin:0 4px;"></div>
        <button class="zoom-btn" id="resetViewBtn" title="í™”ë©´ ì´ˆê¸°í™”">âŸ²</button>
      </div>
    </section>
  </div>

  <aside class="preview-panel">
    <div class="section-title">ìµœì¢… ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</div>
    <div class="preview-box">
      <canvas id="previewCanvas"></canvas>
    </div>
  </aside>
</main>

<script>
/* CUTLINE PRO Logic v6.4 - Final Mobile Scroll Fix */

const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });
const svgOverlay = document.getElementById('svgOverlay');
const ghostPoint = document.getElementById('ghostPoint');
const canvasWrapper = document.getElementById('canvasWrapper');
const canvasContainer = document.getElementById('canvasContainer');
const previewCanvas = document.getElementById('previewCanvas');
const previewCtx = previewCanvas.getContext('2d');
const fileInput = document.getElementById('fileInput');
const dropZoneSidebar = document.getElementById('dropZoneSidebar');
const workspaceDropZone = document.getElementById('workspaceDropZone');
const lineColorInput = document.getElementById('lineColorInput');

let img = new Image();
let points = [];
let originalPoints = []; 
let centerPoint = { x: 0, y: 0 };
let isClosed = false;
let historyStack = [];
let historyStep = -1;

// View State
let scale = 1;
let translate = {x:0, y:0};

// Interaction
let isDraggingPoint = -1;
let eraseMode = false;
let pointEraserMode = false; 
let isPanning = false;
let startPan = {x:0, y:0};
let snapInfo = null; 

// Touch Variables
let initialPinchDistance = null;
let lastScale = 1;

// --- Helper ---
function resetTools() {
  eraseMode = false;
  pointEraserMode = false;
  document.getElementById('eraseModeBtn').classList.remove('active');
  document.getElementById('pointEraserBtn').classList.remove('active');
  
  canvasContainer.classList.remove('erase-cursor');
  canvasContainer.classList.remove('point-erase-cursor');
  canvasContainer.classList.remove('point-erase-active');
  
  ghostPoint.classList.remove('visible');
  snapInfo = null;
}

// --- Presets Logic ---
function applyPreset(type) {
  const marginRange = document.getElementById('marginInput');
  const widthRange = document.getElementById('widthInput');

  if (type === 'sticker') {
    marginRange.value = 10; widthRange.value = 15; lineColorInput.value = '#ffffff';
  } else if (type === 'acrylic') {
    marginRange.value = 25; widthRange.value = 0; lineColorInput.value = '#ff0000';
  } else if (type === 'badge') {
    marginRange.value = 40; widthRange.value = 5; lineColorInput.value = '#ffffff';
  }
  
  document.getElementById('marginDisplay').textContent = marginRange.value;
  document.getElementById('widthDisplay').textContent = widthRange.value;
  updatePointsWithMargin();
  renderPreview();
}

// --- History ---
function saveState(actionName) {
  if (historyStep < historyStack.length - 1) historyStack = historyStack.slice(0, historyStep + 1);
  historyStack.push({
    imageData: ctx.getImageData(0, 0, canvas.width, canvas.height),
    points: JSON.parse(JSON.stringify(points)),
    originalPoints: JSON.parse(JSON.stringify(originalPoints)),
    centerPoint: { ...centerPoint },
    isClosed: isClosed
  });
  if (historyStack.length > 20) historyStack.shift(); else historyStep++;
  updateUI();
}
function undo() { if (historyStep > 0) { historyStep--; restoreState(historyStack[historyStep]); } }
function redo() { if (historyStep < historyStack.length - 1) { historyStep++; restoreState(historyStack[historyStep]); } }
function restoreState(state) {
  canvas.width = state.imageData.width; canvas.height = state.imageData.height;
  ctx.putImageData(state.imageData, 0, 0);
  points = JSON.parse(JSON.stringify(state.points));
  originalPoints = JSON.parse(JSON.stringify(state.originalPoints));
  centerPoint = { ...state.centerPoint };
  isClosed = state.isClosed;
  syncCanvasSizeCSS(); renderOverlay(); renderPreview(); updateUI();
}

// --- Init ---
function initCanvas(w, h) {
  canvas.width = w; canvas.height = h;
  syncCanvasSizeCSS();
  historyStack = []; historyStep = -1; points = []; originalPoints = []; isClosed = false;
  scale = 1; translate = {x:0, y:0}; updateTransform();
  resetTools();
  ctx.drawImage(img, 0, 0, w, h);
  saveState("Loaded");
}
function syncCanvasSizeCSS() {
  canvas.style.width = canvas.width + 'px'; canvas.style.height = canvas.height + 'px';
  canvasWrapper.style.width = canvas.width + 'px'; canvasWrapper.style.height = canvas.height + 'px';
  svgOverlay.setAttribute('viewBox', `0 0 ${canvas.width} ${canvas.height}`);
}

/* Drag & Drop Logic */
fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

dropZoneSidebar.addEventListener('dragover', e => { e.preventDefault(); dropZoneSidebar.style.borderColor = 'var(--primary)'; dropZoneSidebar.style.background = '#eff6ff'; });
dropZoneSidebar.addEventListener('dragleave', e => { e.preventDefault(); dropZoneSidebar.style.borderColor = '#d1d5db'; dropZoneSidebar.style.background = '#f9fafb'; });
dropZoneSidebar.addEventListener('drop', e => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); });

workspaceDropZone.addEventListener('dragover', e => { e.preventDefault(); workspaceDropZone.classList.add('drag-active'); });
workspaceDropZone.addEventListener('dragleave', e => { e.preventDefault(); workspaceDropZone.classList.remove('drag-active'); });
workspaceDropZone.addEventListener('drop', e => { e.preventDefault(); workspaceDropZone.classList.remove('drag-active'); handleFile(e.dataTransfer.files[0]); });

function handleFile(file) {
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => { img = new Image(); img.onload = () => initCanvas(img.width, img.height); img.src = ev.target.result; };
  reader.readAsDataURL(file);
}

// --- View Control ---
function updateTransform() {
  canvasWrapper.style.transform = `translate(${translate.x}px, ${translate.y}px) scale(${scale})`;
  document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + "%";
}
document.getElementById('resetViewBtn').addEventListener('click', () => { scale = 1; translate = {x:0, y:0}; updateTransform(); });
document.getElementById('zoomIn').addEventListener('click', () => { scale *= 1.2; updateTransform(); });
document.getElementById('zoomOut').addEventListener('click', () => { scale /= 1.2; updateTransform(); });
canvasContainer.addEventListener('wheel', e => {
  e.preventDefault(); scale *= e.deltaY > 0 ? 0.9 : 1.1; updateTransform();
}, {passive: false});

// Pan (Desktop)
window.addEventListener('keydown', e => {
  if(e.code === 'Space') {
    canvasContainer.classList.add('panning');
    ghostPoint.classList.remove('visible'); canvasContainer.classList.remove('add-point-cursor');
  }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z') { e.preventDefault(); e.shiftKey ? redo() : undo(); }
});
window.addEventListener('keyup', e => { 
  if(e.code==='Space') { canvasContainer.classList.remove('panning'); }
});
canvasContainer.addEventListener('mousedown', e => {
  if (e.button === 1 || e.getModifierState('Space')) {
    isPanning = true; startPan = { x: e.clientX - translate.x, y: e.clientY - translate.y };
    canvasContainer.classList.add('panning'); e.preventDefault(); e.stopPropagation();
  }
});
window.addEventListener('mousemove', e => {
  if (isPanning) { translate.x = e.clientX - startPan.x; translate.y = e.clientY - startPan.y; updateTransform(); }
});
window.addEventListener('mouseup', () => { 
  isPanning = false; if(!event.getModifierState('Space')) canvasContainer.classList.remove('panning'); 
});

/* --- Mobile Touch Events --- */
canvasContainer.addEventListener('touchstart', (e) => {
  if (e.touches.length === 1) {
    isPanning = true;
    startPan = { x: e.touches[0].clientX - translate.x, y: e.touches[0].clientY - translate.y };
  } else if (e.touches.length === 2) {
    isPanning = false; 
    initialPinchDistance = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
    lastScale = scale;
  }
}, { passive: false });

canvasContainer.addEventListener('touchmove', (e) => {
  e.preventDefault(); 
  if (e.touches.length === 1 && isPanning) {
    translate.x = e.touches[0].clientX - startPan.x;
    translate.y = e.touches[0].clientY - startPan.y;
    updateTransform();
  } else if (e.touches.length === 2 && initialPinchDistance) {
    const currentDistance = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
    const ratio = currentDistance / initialPinchDistance;
    scale = lastScale * ratio;
    updateTransform();
  }
}, { passive: false });

canvasContainer.addEventListener('touchend', () => {
  isPanning = false;
  initialPinchDistance = null;
});

// --- Math ---
function getLocalPos(e) {
  const rect = canvasWrapper.getBoundingClientRect();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  return { x: (clientX - rect.left) / scale, y: (clientY - rect.top) / scale };
}

function getProjectedPoint(p, v, w) {
  const l2 = (v.x - w.x)**2 + (v.y - w.y)**2;
  if (l2 === 0) return v;
  let t = ((p.x - v.x) * (w.x - v.x) + (p.y - v.y) * (w.y - v.y)) / l2;
  t = Math.max(0, Math.min(1, t));
  return { x: v.x + t * (w.x - v.x), y: v.y + t * (w.y - v.y) };
}

function findClosestSnap(pos) {
  if (points.length < 2) return null;
  let minDist = Infinity;
  let result = null;
  const threshold = 12 / scale;

  for(let i=0; i<points.length; i++) {
    if (!isClosed && i === points.length-1) break;
    const p1 = points[i];
    const p2 = points[(i+1)%points.length];
    
    const proj = getProjectedPoint(pos, p1, p2);
    const d = Math.sqrt((pos.x - proj.x)**2 + (pos.y - proj.y)**2);
    
    if (d < minDist) {
      minDist = d;
      result = { index: i, pos: proj, dist: d };
    }
  }
  
  if (result && result.dist < threshold) return result;
  return null;
}

// --- Interaction ---
canvasWrapper.addEventListener('mousedown', (e) => {
  if (!img.src || isPanning || e.button !== 0 || e.getModifierState('Space')) return;
  handleAction(e);
});

function handleAction(e) {
  const pos = getLocalPos(e);

  if (pointEraserMode) {
    if (e.target.tagName === 'circle' && !e.target.classList.contains('ghost-point')) {
      const idx = parseInt(e.target.dataset.index);
      points.splice(idx, 1);
      if (originalPoints.length > 0) originalPoints.splice(idx, 1);
      renderOverlay();
      saveState("ì  ì‚­ì œ");
    }
    return;
  }

  if (e.target.tagName === 'circle' && !e.target.classList.contains('ghost-point')) {
    isDraggingPoint = parseInt(e.target.dataset.index);
    return;
  }

  if (eraseMode) {
    floodErase(Math.round(pos.x), Math.round(pos.y));
    return;
  }

  if (snapInfo) {
    points.splice(snapInfo.index + 1, 0, snapInfo.pos);
    if (originalPoints.length > 0) {
        originalPoints.splice(snapInfo.index + 1, 0, snapInfo.pos);
    }
    saveState("ì  ì¶”ê°€");
    snapInfo = null;
    renderOverlay();
    return;
  }

  if (!isClosed) {
    points.push(pos);
    if (originalPoints.length > 0 || points.length === 1) {
        originalPoints.push(pos);
    }
    renderOverlay();
  }
}

window.addEventListener('mousemove', e => {
  if (!img.src || isPanning || isDraggingPoint > -1) {
    if (isDraggingPoint > -1) { 
        const newPos = getLocalPos(e);
        points[isDraggingPoint] = newPos; 
        if (originalPoints[isDraggingPoint]) originalPoints[isDraggingPoint] = newPos;
        renderOverlay(); 
    }
    return;
  }

  const pos = getLocalPos(e);

  if (!eraseMode && !pointEraserMode && points.length > 1) {
    const snap = findClosestSnap(pos);
    
    if (snap) {
      snapInfo = snap;
      canvasContainer.classList.add('add-point-cursor');
      ghostPoint.classList.add('visible');
      ghostPoint.setAttribute('cx', snap.pos.x);
      ghostPoint.setAttribute('cy', snap.pos.y);
    } else {
      snapInfo = null;
      canvasContainer.classList.remove('add-point-cursor');
      ghostPoint.classList.remove('visible');
    }
  }
});

window.addEventListener('mouseup', () => {
  if(isDraggingPoint > -1) { saveState("ì  ì´ë™"); isDraggingPoint = -1; }
});

// --- Tools Logic ---
function floodErase(sx, sy) {
  const w=canvas.width, h=canvas.height;
  const imageData = ctx.getImageData(0,0,w,h);
  const data = imageData.data;
  const tol = parseInt(document.getElementById('toleranceInput').value);
  const startIdx = (sy*w+sx)*4;
  const sc = [data[startIdx], data[startIdx+1], data[startIdx+2], data[startIdx+3]];
  if (sc[3] === 0) return; 

  const stack = [[sx, sy]];
  const visited = new Uint8Array(w*h);
  while(stack.length) {
    const [x,y] = stack.pop();
    const idx = y*w+x;
    if(x<0||x>=w||y<0||y>=h||visited[idx]) continue;
    visited[idx]=1;
    const i=idx*4;
    const diff = Math.abs(data[i]-sc[0]) + Math.abs(data[i+1]-sc[1]) + Math.abs(data[i+2]-sc[2]);
    if (diff <= tol && data[i+3]>0) {
      data[i+3]=0; stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
    }
  }
  ctx.putImageData(imageData,0,0); saveState("ì§€ìš°ê°œ"); renderPreview();
}

document.getElementById('removeBgBtn').addEventListener('click', () => {
  if (!img.src) return;
  resetTools();
  const w=canvas.width, h=canvas.height;
  const imageData = ctx.getImageData(0,0,w,h);
  const data = imageData.data;
  const tol = parseInt(document.getElementById('toleranceInput').value);
  const bg = [data[0], data[1], data[2]]; 
  const stack = [[0,0], [w-1,0], [0,h-1], [w-1,h-1]];
  const visited = new Uint8Array(w*h);
  while(stack.length) {
    const [x,y] = stack.pop();
    const idx = y*w+x;
    if(x<0||x>=w||y<0||y>=h||visited[idx]) continue;
    visited[idx]=1;
    const i=idx*4;
    const diff = Math.abs(data[i]-bg[0]) + Math.abs(data[i+1]-bg[1]) + Math.abs(data[i+2]-bg[2]);
    if (diff < tol*3 || data[i+3] < 20) {
      data[i+3] = 0; stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
    }
  }
  ctx.putImageData(imageData, 0, 0); saveState("ìë™ ë°°ê²½ ì œê±°"); renderPreview();
});

document.getElementById('erodeBtn').addEventListener('click', () => {
  resetTools();
  const w=canvas.width, h=canvas.height;
  const src = ctx.getImageData(0,0,w,h), dst = ctx.createImageData(w,h);
  const s=src.data, d=dst.data; d.set(s);
  for(let y=1; y<h-1; y++){
    for(let x=1; x<w-1; x++){
      const i=(y*w+x)*4;
      if(s[i+3]===0) continue;
      if(s[((y-1)*w+x)*4+3]===0 || s[((y+1)*w+x)*4+3]===0 || s[(y*w+x-1)*4+3]===0 || s[(y*w+x+1)*4+3]===0) d[i+3]=0;
    }
  }
  ctx.putImageData(dst,0,0); saveState("ê°€ì¥ìë¦¬ ê¹ê¸°"); renderPreview();
});

document.getElementById('eraseModeBtn').addEventListener('click', (e) => {
  const wasActive = eraseMode;
  resetTools();
  if (!wasActive) {
    eraseMode = true;
    e.target.classList.add('active');
    canvasContainer.classList.add('erase-cursor');
  }
});

document.getElementById('pointEraserBtn').addEventListener('click', (e) => {
  const wasActive = pointEraserMode;
  resetTools();
  if (!wasActive) {
    pointEraserMode = true;
    e.target.classList.add('active');
    canvasContainer.classList.add('point-erase-cursor');
    canvasContainer.classList.add('point-erase-active'); 
  }
});

document.getElementById('canvasBgPicker').addEventListener('input', (e) => {
  canvasContainer.style.backgroundImage = 'none';
  canvasContainer.style.backgroundColor = e.target.value;
});

// Auto Outline
document.getElementById('autoOutlineBtn').addEventListener('click', () => {
  if (!img.src) return;
  resetTools();
  const w=canvas.width, h=canvas.height;
  const data = ctx.getImageData(0,0,w,h).data;
  let tx=0, ty=0, c=0;
  for(let i=3; i<data.length; i+=4) if(data[i]>100) { const idx=(i-3)/4; tx+=idx%w; ty+=Math.floor(idx/w); c++; }
  if(c===0) return alert("ì´ë¯¸ì§€ ë‚´ìš© ì—†ìŒ");
  centerPoint = { x: tx/c, y: ty/c };
  const cx=centerPoint.x, cy=centerPoint.y;
  const temp = []; const rays = 120;
  for(let i=0; i<rays; i++) {
    const ang = (Math.PI*2*i)/rays; const dx=Math.cos(ang), dy=Math.sin(ang);
    for(let r=Math.max(w,h); r>=0; r-=2) {
      const x=Math.round(cx+dx*r), y=Math.round(cy+dy*r);
      if(x>=0&&x<w&&y>=0&&y<h&&data[(y*w+x)*4+3]>20) {
        temp.push({x:cx+dx*(r+5), y:cy+dy*(r+5)}); break;
      }
    }
  }
  points = temp;
  originalPoints = JSON.parse(JSON.stringify(temp));
  isClosed = true;
  updatePointsWithMargin(); 
  saveState("ìë™ ì»·ë¼ì¸"); renderOverlay();
});

document.getElementById('closePathBtn').addEventListener('click', ()=>{ resetTools(); isClosed=true; renderOverlay(); });
document.getElementById('resetPointsBtn').addEventListener('click', ()=>{ resetTools(); points=[]; originalPoints=[]; isClosed=false; renderOverlay(); });

// --- Smooth Points Function ---
function smoothPoints(pts, iterations) {
    if (iterations <= 0) return pts;
    let curr = [...pts];
    for (let k = 0; k < iterations; k++) {
        const next = [];
        const n = curr.length;
        for (let i = 0; i < n; i++) {
            const prev = curr[(i - 1 + n) % n];
            const p = curr[i];
            const nextP = curr[(i + 1) % n];
            next.push({
                x: (prev.x + 2 * p.x + nextP.x) / 4,
                y: (prev.y + 2 * p.y + nextP.y) / 4
            });
        }
        curr = next;
    }
    return curr;
}

// --- Margin & Smooth Calculation ---
function updatePointsWithMargin() {
    if (originalPoints.length === 0) return;
    const margin = parseInt(document.getElementById('marginInput').value) || 0;
    const smoothIter = parseInt(document.getElementById('smoothInput').value) || 0;

    // 1. Apply Margin
    let marginedPoints = [];
    if (margin === 0) {
        marginedPoints = JSON.parse(JSON.stringify(originalPoints));
    } else {
        for (let i = 0; i < originalPoints.length; i++) {
            const p = originalPoints[i];
            const dx = p.x - centerPoint.x;
            const dy = p.y - centerPoint.y;
            const len = Math.sqrt(dx*dx + dy*dy);
            if (len > 0) {
                const ndx = dx / len;
                const ndy = dy / len;
                marginedPoints.push({
                    x: p.x + ndx * margin,
                    y: p.y + ndy * margin
                });
            } else {
                marginedPoints.push(p);
            }
        }
    }

    // 2. Apply Smoothing
    points = smoothPoints(marginedPoints, smoothIter);
}

function renderOverlay() {
  let html = '<circle id="ghostPoint" class="ghost-point" cx="0" cy="0" r="5" />'; 
  if (points.length > 1) {
    const pts = points.map(p => `${p.x},${p.y}`).join(' ');
    const close = isClosed ? ` ${points[0].x},${points[0].y}` : '';
    html += `<polyline points="${pts}${close}" />`;
  }
  points.forEach((p, i) => {
    html += `<circle cx="${p.x}" cy="${p.y}" r="4" data-index="${i}" />`;
  });
  svgOverlay.innerHTML = html;
  
  const newGhost = document.getElementById('ghostPoint');
  if(ghostPoint && ghostPoint.classList.contains('visible')) {
      newGhost.classList.add('visible');
      newGhost.setAttribute('cx', ghostPoint.getAttribute('cx'));
      newGhost.setAttribute('cy', ghostPoint.getAttribute('cy'));
  }
  renderPreview();
}

function renderPreview() {
  if(!img.src) return;
  const margin = parseInt(document.getElementById('marginInput').value);
  const width = parseInt(document.getElementById('widthInput').value);
  const color = document.getElementById('lineColorInput').value;
  let minX=1e5, maxX=0, minY=1e5, maxY=0;
  if(points.length===0) { minX=0; maxX=canvas.width; minY=0; maxY=canvas.height; }
  else points.forEach(p=>{ minX=Math.min(minX,p.x); maxX=Math.max(maxX,p.x); minY=Math.min(minY,p.y); maxY=Math.max(maxY,p.y); });
  const pad = width + 20;
  const pw = (maxX-minX)+pad*2, ph = (maxY-minY)+pad*2;
  previewCanvas.width = pw; previewCanvas.height = ph;
  if (points.length>2 && isClosed) {
    previewCtx.lineJoin='round'; previewCtx.lineCap='round';
    previewCtx.strokeStyle=color; previewCtx.lineWidth=width;
    previewCtx.beginPath();
    points.forEach((p,i)=> i===0?previewCtx.moveTo(p.x-minX+pad,p.y-minY+pad):previewCtx.lineTo(p.x-minX+pad,p.y-minY+pad));
    previewCtx.closePath(); previewCtx.stroke();
  }
  previewCtx.drawImage(canvas, -minX+pad, -minY+pad);
}

// --- UI Sync ---
function sync(range, disp) { 
    const r=document.getElementById(range),d=document.getElementById(disp); 
    r.addEventListener('input',()=>{
        d.textContent=r.value;
        if (range === 'marginInput' || range === 'smoothInput') updatePointsWithMargin(); 
        renderOverlay(); 
    }); 
}
sync('toleranceInput','tolDisplay'); 
sync('marginInput','marginDisplay'); 
sync('widthInput','widthDisplay');
sync('smoothInput','smoothDisplay'); 

lineColorInput.addEventListener('input', () => { renderPreview(); });

document.getElementById('undoBtn').addEventListener('click', undo);
document.getElementById('redoBtn').addEventListener('click', redo);
document.getElementById('downloadBtn').addEventListener('click', () => {
  const a = document.createElement('a'); a.download = 'cutline_final.png'; a.href = previewCanvas.toDataURL(); a.click();
});
function updateUI() {
  document.getElementById('undoBtn').disabled = historyStep <= 0;
  document.getElementById('redoBtn').disabled = historyStep >= historyStack.length - 1;
}

// --- Security Scripts ---
document.addEventListener('contextmenu', function (e) {
  e.preventDefault();
  alert('ë³´ì•ˆì„ ìœ„í•´ ìš°í´ë¦­ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
});

document.addEventListener('keydown', function (e) {
  if (
    e.key === 'F12' ||
    (e.ctrlKey && e.shiftKey && e.key === 'I') ||
    (e.ctrlKey && e.shiftKey && e.key === 'J') ||
    (e.ctrlKey && e.key === 'U')
  ) {
    e.preventDefault();
    alert('ì†ŒìŠ¤ ì½”ë“œ ë³´ê¸°ëŠ” ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
  }
});
</script>
</body>
</html>
